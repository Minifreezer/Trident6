#####################################################################
#   Cancel/Pause/Resume Client Variables Macro
#####################################################################

[gcode_macro _CLIENT_VARIABLE]
#variable_use_custom_pos   : False ; use custom park coordinates for x,y [True/False]
#variable_custom_park_x    : 0.0   ; custom x position; value must be within your defined min and max of X
#variable_custom_park_y    : 0.0   ; custom y position; value must be within your defined min and max of Y
variable_custom_park_dz    : 5.0   ; custom dz value; the value in mm to lift the nozzle when move to park position
variable_retract           : 1.0   ; the value to retract while PAUSE
variable_cancel_retract    : 5.0   ; the value to retract while CANCEL_PRINT
#variable_speed_retract    : 35.0  ; retract speed in mm/s
#variable_unretract        : 1.0   ; the value to unretract while RESUME
#variable_speed_unretract  : 35.0  ; unretract speed in mm/s
#variable_speed_hop        : 15.0  ; z move speed in mm/s
#variable_speed_move       : 100.0 ; move speed in mm/s
variable_park_at_cancel   : True ; allow to move the toolhead to park while execute CANCEL_PRINT [True/False]
variable_park_at_cancel_x : 315  ; different park position during CANCEL_PRINT [None/Position as Float]; park_at_cancel must be True
variable_park_at_cancel_y : 294  ; different park position during CANCEL_PRINT [None/Position as Float]; park_at_cancel must be True
## !!! Caution [firmware_retraction] must be defined in the printer.cfg if you set use_fw_retract: True !!!
#variable_use_fw_retract   : False ; use fw_retraction instead of the manual version [True/False]
#variable_idle_timeout     : 0     ; time in sec until idle_timeout kicks in. Value 0 means that no value will be set or restored
#variable_runout_sensor    : ""    ; If a sensor is defined, it will be used to cancel the execution of RESUME in case no filament is detected.
##                                   Specify the config name of the runout sensor e.g "filament_switch_sensor runout". Hint use the same as in your printer.cfg
## !!! Custom macros, please use with care and review the section of the corresponding macro.
## These macros are for simple operations like setting a status LED. Please make sure your macro does not interfere with the basic macro functions.
## Only  single line commands are supported, please create a macro if you need more than one command.
variable_user_pause_macro : "SAVE_GCODE_STATE NAME=PAUSE_STATE"    ; Everything inside the "" will be executed after the klipper base pause (PAUSE_BASE) function
variable_user_resume_macro: "RESTORE_GCODE_STATE NAME=PAUSE_STATE\nSTATUS_PRINTING"    ; Everything inside the "" will be executed before the klipper base resume (RESUME_BASE) function
variable_user_cancel_macro: "CANCEL_ZMAX_MSG"    ; Everything inside the "" will be executed before the klipper base cancel (CANCEL_PRINT_BASE) function
gcode:

[gcode_macro CANCEL_ZMAX_MSG]
gcode:
  {% if "z" in printer.toolhead.homed_axes %}
    {% set zmax = printer.toolhead.axis_maximum.z|float %}
    {% set safez = (zmax - 0.5)|float %}  ; 0.5mm safety margin
    G90
    G0 Z{safez} F900
  {% endif %}
  M118 CANCEL COMPLETE - Toolhead parked (below Z max)

[gcode_macro SET_TAP_OFFSET_ZERO]
gcode:
    PROBE_EDDY_NG_SET_TAP_OFFSET VALUE=0

[gcode_macro RESTORE_LIMITS]
gcode:
  {% set p = printer.configfile.settings.printer %}
  {% set v = p.max_velocity|float %}
  {% set a = p.max_accel|float %}
  {% set atd = (p.max_accel_to_decel|default(a))|float %}
  {% set scv = (p.square_corner_velocity|default(5.0))|float %}
  SET_VELOCITY_LIMIT VELOCITY={v} ACCEL={a} ACCEL_TO_DECEL={atd} SQUARE_CORNER_VELOCITY={scv}

[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_MS
gcode:
  PROBE_EDDY_NG_SET_TAP_OFFSET VALUE=0
  BED_MESH_CLEAR
  CANCEL_ZMAX_MSG
  CANCEL_PRINT_MS
  RESTORE_LIMITS

#[gcode_macro PAUSE]
#description: Pause (wrapper) - adds state save, then calls Mainsail PAUSE
#rename_existing: PAUSE_MS
#gcode:
  #SAVE_GCODE_STATE NAME=PAUSE_STATE
  #PAUSE_MS {rawparams}

#[gcode_macro RESUME]
#description: Resume (wrapper) - reheat, restore state, then call original RESUME
#rename_existing: RESUME_MS
#gcode:
 # {% set t = printer.extruder.target|float %}
  #{% if t > 0 %}
   # M109 S{t|int}        ; wait for nozzle back to target temp
  #{% endif %}
  #RESTORE_GCODE_STATE NAME=PAUSE_STATE
  #RESUME_MS {rawparams}


###################################################################
#    EddyNG Setup and Calibration
###################################################################

##### Automatice Calibration #####

[gcode_macro EDDYNG_AUTOMATIC_SETUP]
gcode:
    G28 X Y
    G1 X152.5 Y148 F6000
    M104 S150
    M106 S64
    M190 S60
    PROBE_EDDY_NG_SETUP
    

##### Manual Calibration #####

[gcode_macro EDDYNG_MANUAL_CALIBRATE]
gcode:
    M104 S150
    M106 S64
    M190 S60
    PROBE_EDDY_NG_CALIBRATE

[gcode_macro EDDYNG_STATUS]
gcode:
    PROBE_EDDY_NG_STATUS

[gcode_macro EDDYNG_CLEAR_CALIBRATION]
gcode:
    PROBE_EDDY_NG_CLEAR_CALIBRATION

[gcode_macro CLEAR_EDDYNG_TAP_OFFSET]
gcode:
    PROBE_EDDY_NG_SET_TAP_OFFSET VALUE=0
    
###################################################################
#    EddyNG Safety/Functionality Checks
###################################################################

[gcode_macro EDDYNG_PROBE_STATIC]
gcode:
    PROBE_EDDY_NG_PROBE_STATIC

[gcode_macro EDDYNG_PROBE_ACCURACY]
gcode:
    PROBE_EDDY_NG_PROBE_ACCURACY

[gcode_macro EDDYNG_TAP]
gcode:
    G28 X Y Z
    G1 X152.5 Y148 F6000
    M104 S150
    M106 S64
    M190 S60
    PROBE_EDDY_NG_TAP

[gcode_macro EDDYNG_STATUS]
gcode:
    PROBE_EDDY_NG_STATUS

###################################################################
#    Bed Mesh and Leveling
###################################################################

[gcode_macro BED_MESH_RAPID_SCAN]
gcode:
    Z_TILT_ADJUST
    BED_MESH_CALIBRATE METHOD=rapid_scan

###################################################################
#   Testing/Calibration
###################################################################

[gcode_macro _TEST_BELTS]
gcode:
  {% if 'x' not in printer.toolhead.homed_axes %}
  {% if 'y' not in printer.toolhead.homed_axes %}
  G28 X Y 
  {% endif %}
  {% endif %}
 
  {% set circles = params.S|default(1)|int %}
  {% set rate = params.F|default(18000)|int %}
  {% for i in range(circles) %}
      G1 X{printer.toolhead.axis_minimum.x + 15} Y{printer.toolhead.axis_minimum.y + 15}  F{rate}
      G1 X{printer.toolhead.axis_maximum.x - 15} Y{printer.toolhead.axis_minimum.y + 15}  F{rate}
      G1 X{printer.toolhead.axis_maximum.x - 15} Y{printer.toolhead.axis_maximum.y - 15} F{rate}
      G1 X{printer.toolhead.axis_minimum.x + 15} Y{printer.toolhead.axis_maximum.y - 15}  F{rate}
      G1 X{printer.toolhead.axis_minimum.x + 15} Y{printer.toolhead.axis_minimum.y + 15}  F{rate}
    {% endfor %}
    G1 X{ printer.toolhead.axis_maximum.x / 2  } Y{printer.toolhead.axis_maximum.y  /2}  F{rate}

###################################################################
#    Klipper Back Up yo Github
###################################################################

[gcode_macro update_git]
gcode:
    {% set message = params.MESSAGE|default() %}
    {% if message %}
        RUN_SHELL_COMMAND CMD=update_git_script_message PARAMS="'{params.MESSAGE}'"
    {% else %}
        RUN_SHELL_COMMAND CMD=update_git_script
    {% endif %}

[gcode_shell_command update_git_script]
command: bash -c "bash $HOME/klipper-backup/script.sh"
timeout: 90.0
verbose: True

[gcode_shell_command update_git_script_message]
command: bash -c "bash $HOME/klipper-backup/script.sh -c \"$0\""
timeout: 90.0
verbose: True
