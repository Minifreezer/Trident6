############################################################
# LOAD FILAMENT (KlipperScreen prompt + auto-heat by type)
############################################################

[gcode_macro LOAD_FILAMENT]
description: Show filament-type prompt in UI (KlipperScreen/Mainsail/Fluidd)
variable_load_distance:  100
variable_purge_distance: 25
gcode:
  RESPOND TYPE=command MSG="action:prompt_begin Load Filament"
  RESPOND TYPE=command MSG="action:prompt_text Select filament type:"
  RESPOND TYPE=command MSG="action:prompt_button PLA|LOAD_FILAMENT_TYPE FILAMENT=PLA|primary"
  RESPOND TYPE=command MSG="action:prompt_button PETG|LOAD_FILAMENT_TYPE FILAMENT=PETG"
  RESPOND TYPE=command MSG="action:prompt_button ABS|LOAD_FILAMENT_TYPE FILAMENT=ABS"
  RESPOND TYPE=command MSG="action:prompt_button ASA|LOAD_FILAMENT_TYPE FILAMENT=ASA"
  RESPOND TYPE=command MSG="action:prompt_button TPU|LOAD_FILAMENT_TYPE FILAMENT=TPU"
  RESPOND TYPE=command MSG="action:prompt_button Cancel|LOAD_FILAMENT_CANCEL|warning"
  RESPOND TYPE=command MSG="action:prompt_show"


[gcode_macro LOAD_FILAMENT_CANCEL]
gcode:
  RESPOND TYPE=command MSG="action:prompt_end"
  M118 Load filament cancelled
  SET_DISPLAY_TEXT MSG="Load filament cancelled"


[gcode_macro LOAD_FILAMENT_TYPE]
description: Heat by filament type then run the actual load
gcode:
  {% set f = params.FILAMENT|default("PLA")|upper %}
  {% set temps = {
      "PLA": 220,
      "PETG": 240,
      "ABS": 250,
      "ASA": 250,
      "TPU": 225
    }
  %}
  {% set t = temps.get(f, 210) %}

  RESPOND TYPE=command MSG="action:prompt_end"
  M118 Loading {f} - heating nozzle to {t|int}C
  SET_DISPLAY_TEXT MSG="Loading {f} - heating to {t}C"

# Set target temp and start as soon as it reaches temp (no settle wait)
  M104 S{t|int}
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={t - 0.5}

  _LOAD_FILAMENT_CORE

# ---- Your original load macro logic lives here (mostly unchanged) ----
[gcode_macro _LOAD_FILAMENT_CORE]
gcode:
  {% set speed = params.SPEED|default(300)|float %}
  {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity * 60 %}
  {% set st = printer.print_stats.state|string %}

  SAVE_GCODE_STATE NAME=load_state
  G91
  G92 E0
  G1 E{printer["gcode_macro LOAD_FILAMENT"].load_distance} F{max_velocity} ; fast-load
  G1 E{printer["gcode_macro LOAD_FILAMENT"].purge_distance} F{speed}       ; purge
  RESTORE_GCODE_STATE NAME=load_state

# Turn heaters off only when NOT in a print/paused state
  {% if st in ["printing", "paused"] %}
    M118 Load complete - keeping nozzle hot ({st})
    SET_DISPLAY_TEXT MSG="Load complete - nozzle kept hot"
  {% else %}
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
    M118 Nozzle heater turned off
    SET_DISPLAY_TEXT MSG="Nozzle heater off"
  {% endif %}


##########################################################################################################

[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance:  200
variable_purge_distance:   1
gcode:
  {% set target = params.TEMP|default(250)|float %}
  {% set speed = params.SPEED|default(300)|float %}
  {% set scale = (params.SCALE|float) if ('SCALE' in params) else 0.5 %}
  {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity * 60 %}
  {% set unload_velocity = max_velocity * scale %}
  {% set st = printer.print_stats.state|string %}

  # Heat nozzle to target and start as soon as it reaches temp (no settle wait)
  M104 S{target|int}
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={target - 0.5}

  SAVE_GCODE_STATE NAME=unload_state
  G91
  G92 E0
  G1 E{printer["gcode_macro UNLOAD_FILAMENT"].purge_distance} F{speed}        ; purge
  G1 E-{printer["gcode_macro UNLOAD_FILAMENT"].unload_distance} F{unload_velocity} ; fast-unload
  RESTORE_GCODE_STATE NAME=unload_state

  # Turn heater off only if NOT in a print/paused state
  {% if st in ["printing", "paused"] %}
    M118 Unload complete - keeping nozzle hot ({st})
    SET_DISPLAY_TEXT MSG="Unload complete - nozzle kept hot"
  {% else %}
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
    M118 Nozzle heater turned off
    SET_DISPLAY_TEXT MSG="Nozzle heater off"
  {% endif %}


##############################################################################################################

#[filament_switch_sensor extruder_sensor]
#pause_on_runout: True
#event_delay: 3.0
#pause_delay: 0.5
#debounce_delay: 0.3
#switch_pin: !PG12
#runout_gcode:
#  M118 FILAMENT RUNOUT! Print paused - load filament and RESUME.
#  SET_DISPLAY_TEXT MSG="FILAMENT RUNOUT! Load filament, then RESUME."
#
#  SAVE_GCODE_STATE NAME=FIL_RUNOUT_STATE
  ; NOTE: Since pause_on_runout is True, Klipper will PAUSE automatically
  ; after the runout is detected. No need to call PAUSE again here.

  ; Z hop (donâ€™t crash if already near max)
#  {% set z_hop = 10.0 %}
#  {% set z_lift = [z_hop, (printer.toolhead.axis_maximum.z - printer.toolhead.position.z)] | min %}
#  {% if z_lift > 0 %}
#    G91
#    G1 Z{z_lift} F900
#    G90
#  {% endif %}

  ; Park (choose a safe location for your machine)
#  G1 X296 Y25 F9000

#insert_gcode:
#  M118 Filament detected. Priming 5mm...
#  G91
#  G1 E5 F300
#  G90
#  M118 Primed. Use RESUME when ready.

##################################################################################################################
